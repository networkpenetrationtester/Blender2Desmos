<!DOCTYPE html>
<html>

<head>
    <title>Obj2Desmos</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.desmos.com/api/v1.12/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>
    <script>
        var socket = io();
        var Vertices, Faces, mesh_expressions = [];
        function clearMesh() {
            for (id of mesh_expressions) {
                calculator.removeExpression({ "id": id });
            }
            mesh_expressions = [];
        }
        function update() {
            socket.emit("Awake");
            setSettings();
        }
        function setColors() {
            state = calculator.getState();
            c = "C_{olor}";
            state.expressions.list = state.expressions.list.map(
                (e) => ({ ...e, colorLatex: c })
            );
            calculator.setState(state);
        }
        function setSettings() {
            calculator.setExpressions([
                {
                    "id": "Color_Folder",
                    "type": "folder",
                    "title": "Color"
                },
                {
                    "id": "Color",
                    "latex": "C_{olor}=\\operatorname{hsv}\\left(H,S,V\\right)",
                },
                {
                    "id": "H_Angle",
                    "latex": "\\theta_{C}=0",
                    "sliderBounds": {
                        "min": "0",
                        "max": "\\frac{\\pi}{2}"
                    },
                    "playing": false
                },
                {
                    "id": "H",
                    "latex": "H=360\\cos\\left(\\theta_{C}\\right)",
                    "parametricDomain": {
                        "min": "0",
                        "max": "1"
                    },
                    "sliderBounds": {
                        "min": "0",
                        "max": "360"
                    }
                },
                {
                    "id": "S",
                    "latex": "S=1",
                    "parametricDomain": {
                        "min": "0",
                        "max": "1"
                    },
                    "sliderBounds": {
                        "min": "0",
                        "max": "1",
                        "step": "0.01"
                    },
                    "playing": false
                },
                {
                    "id": "V",
                    "latex": "V=1",
                    "parametricDomain": {
                        "min": "0",
                        "max": "1"
                    },
                    "sliderBounds": {
                        "min": "0",
                        "max": "1",
                        "step": "0.01"
                    },
                },
                {
                    "id": "width",
                    "type": "expression",
                    "latex": "W_{idth}=0.1",
                    "color": "#00ff00",
                    "sliderBounds": {
                        "min": "0.0",
                        "max": "10.0"
                    }
                }
            ]);
        }
        socket.on("Desmos", (...args) => {
            try {
                calculator.setBlank();
                setSettings();
                args = JSON.parse(args);
                window.Vertices = args.vertices;
                window.Faces = args.faces;
                //eventually process multiple objects possibly?
                if (args.vertices) {
                    calculator.setExpression({
                        "id": "vertices",
                        "type": "expression",
                        "latex": `v = [${args.vertices.join(",")}]`,
                        "hidden": true,
                        "pointSize": 0.1,
                        "color": "#000000",
                    });
                    mesh_expressions.push("vertices");
                }
                switch (args.mode) {
                    case "wireframe":
                        for (let i in args.faces) {
                            calculator.setExpression({
                                "id": `face-${i}`,
                                "type": "expression",
                                //   v\left[85\right],v\left[88\right],v\left[84\right]  \right)
                                "latex": args.faces[i].join(),
                                "color": "#00ff00",
                                "points": false,
                                "lines": true,
                                "lineWidth": "W_{idth}"
                            });
                            mesh_expressions.push(`face-${i}`);
                        }
                        break;
                    case "triangles":
                        for (let i in args.faces) {
                            calculator.setExpression({
                                "id": `face-${i}`,
                                "type": "expression",
                                //   v\left[85\right],v\left[88\right],v\left[84\right]  \right)
                                "latex": `\\operatorname{triangle}\\left(${args.faces[i].join(",").replaceAll("[", "\\left[").replaceAll("]", "\\right]")}\\right)`,
                                "color": "#00ff00",
                                "points": false,
                                "lines": true,
                                "lineWidth": "W_{idth}"
                            });
                            mesh_expressions.push(`face-${i}`);
                        }
                        break;
                }
                setColors();
            } catch (e) { console.error(e) }
        });
    </script>
</head>

<body onload="update()">
    <div id="calculator" style="width: 1024px; height: 1024px;"></div>
    <script>
        var elt = document.getElementById("calculator");
        var calculator = Desmos.Calculator3D(elt);
    </script>
    <button onclick="update()">Update</button>
</body>

</html>